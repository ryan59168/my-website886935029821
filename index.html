<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="robots" content="noindex">
<title>單字練習_雙向翻牌 (AI修復版)</title>
<style>
:root {
  --bg: #f0f2f5;
  --card-bg: #ffffff;
  --accent: #3182ce;
  --accent-hover: #2b6cb0;
  --text-main: #2d3748;
  --text-sub: #718096;
  --border: #e2e8f0;
  --max-width: 800px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg);
  margin: 0;
  padding: 20px 10px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
  color: var(--text-main);
  line-height: 1.5;
}

.container {
  max-width: var(--max-width);
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* --- 卡片區域 --- */
.card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  position: relative;
  transition: transform 0.2s;
}

/* 模式切換按鈕區 */
.modes {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
  width: 100%;
}

.mode-btn {
  background: #edf2f7;
  color: var(--text-sub);
  border: none;
  padding: 8px 12px;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.mode-btn:hover { background: #e2e8f0; }
.mode-btn.active {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 2px 6px rgba(49, 130, 206, 0.3);
}

/* 顯示區域 */
.display-area {
  width: 100%;
  min-height: 180px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 20px 0;
}

.word-text {
  font-size: 2.2rem;
  font-weight: 700;
  margin: 0;
  line-height: 1.3;
  color: var(--text-main);
  white-space: pre-wrap;
}

.sub-text {
  font-size: 2.2rem;
  color: var(--accent);
  margin-top: 12px;
  font-weight: 750;
  line-height: 1.3;     
  white-space: pre-wrap;
}

.hint-text {
  font-size: 0.9rem;
  color: var(--text-sub);
  margin-top: 8px;
}

/* 發音與AI按鈕容器 */
.action-btns {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* 功能小按鈕 (發音/AI) */
.icon-btn {
  background: #edf2f7;
  border: none;
  cursor: pointer;
  color: var(--text-sub);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.icon-btn:hover { background: #e2e8f0; color: var(--accent); transform: scale(1.05); }
.icon-btn svg { width: 22px; height: 22px; fill: currentColor; }
.hidden { display: none !important; }

/* AI 彈出視窗 (Dialog) */
dialog {
  border: none;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  padding: 0;
  max-width: 500px;
  width: 90%;
  background: #fff;
}
dialog::backdrop {
  background: rgba(0, 0, 0, 0.5);
}
.dialog-header {
  padding: 15px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f8fafc;
}
.dialog-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;}
.close-dialog-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #a0aec0; line-height: 1; }
.dialog-content { padding: 20px; line-height: 1.6; color: #4a5568; font-size: 1rem; white-space: pre-wrap; }

/* 控制按鈕群 */
.controls {
  display: flex;
  gap: 12px;
  width: 100%;
}

.btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: filter 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:active { filter: brightness(0.9); }
.btn-secondary { background: #edf2f7; color: var(--text-main); }
.btn-secondary:active { background: #e2e8f0; }

/* --- 設定區域 --- */
.settings-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid var(--border);
}

.input-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 10px;
}

input[type="text"] {
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  flex: 1;
  min-width: 120px;
}

textarea {
  width: 100%;
  height: 20vw; 
  max-height: 500px; 
  min-height: 250px; 
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: monospace;
  resize: vertical;
  margin-bottom: 10px;
}

/* iframe 容器控制 */
.sheet-container {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  display: none; /* 預設隱藏 */
}
.sheet-container.active {
  display: block;
}

iframe {
  width: 100%;
  height: 75vw; 
  max-height: 700px; 
  min-height: 500px;  
  border: none;
  background: #fff;
  display: block;
}

#statusMsg { font-size: 14px; color: var(--accent); margin-left: 4px; }

/* Mobile 優化 */
@media (max-width: 480px) {
  .word-text { font-size: 1.8rem; }
  .controls { flex-direction: column; }
  .btn { width: 100%; }
  .modes { gap: 6px; }
  .mode-btn { flex: 1; text-align: center; font-size: 13px; padding: 8px 4px;}
}
</style>
</head>
<body>

<div class="container">
  
  <div class="card">
    <div class="modes">
      <button id="m3" class="mode-btn">依序瀏覽</button>
      <button id="m0" class="mode-btn active">隨機抽題</button>
      <button id="m1" class="mode-btn">中 → 英</button>
      <button id="m2" class="mode-btn">英 → 中</button>
    </div>

    <div class="display-area">
      <div id="mainText" class="word-text">按「下一題」開始</div>
      
      <div class="action-btns">
        <button id="speakBtn" class="icon-btn hidden" aria-label="發音">
          <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        </button>
        <button id="aiBtn" class="icon-btn hidden" aria-label="AI 解釋">
          <svg viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5A2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5a2.5 2.5 0 0 0 2.5 2.5a2.5 2.5 0 0 0 2.5-2.5a2.5 2.5 0 0 0-2.5-2.5"/></svg>
        </button>
      </div>

      <div id="subText" class="sub-text"></div>
      <div id="hint" class="hint-text"></div>
    </div>

    <div class="controls">
      <button id="showBtn" class="btn btn-secondary">顯示翻譯</button>
      <button id="nextBtn" class="btn btn-primary">下一題</button>
    </div>
  </div>

  <div class="settings-card">
    <label style="font-weight:600; display:block; margin-bottom:8px;">題庫管理</label>
    
    <div class="input-group">
      <input type="text" id="sheetNameInput" value="1" placeholder="工作表名稱">
      <button id="importBtn" class="btn btn-primary" style="padding: 8px 16px; font-size:14px;">疊加匯入</button>
      <button id="clearBtn" class="btn btn-secondary" style="padding: 8px 16px; font-size:14px;">清空</button>
    </div>
    <div id="statusMsg"></div>

    <textarea id="pairs" placeholder="題庫內容 (格式: 中文 - 英文)"></textarea>
    
    <div style="display:flex; gap:8px;">
      <button id="toggleSheetBtn" class="btn btn-secondary" style="flex:1; padding:10px; font-size:0.9rem;">
        ▼ 展開/隱藏 Google 試算表 (預覽與編輯)
      </button>
      <a href="https://docs.google.com/spreadsheets/d/16y8_QTo0QrQe5El9ylVvps94mhNi7zRuErIrxRkwoQc/edit?usp=sharing" target="_blank" class="btn btn-secondary" style="padding:10px; font-size:0.9rem; text-decoration:none; display:flex; align-items:center; justify-content:center;">
        ↗ 開啟原始檔
      </a>
    </div>
    
    <div id="sheetContainer" class="sheet-container">
      <iframe id="sheetFrame" src=""></iframe>
    </div>

    <small style="color:#718096; display:block; margin-top:8px;">
      * 若要編輯，請直接在下方表格操作（變更會自動儲存到 Google Sheet，請重新匯入以更新題庫）。
    </small>
  </div>
</div>

<dialog id="aiModal">
  <div class="dialog-header">
    <div class="dialog-title">
      <svg style="width:20px;height:20px;fill:#3182ce;margin-right:6px" viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2"/></svg>
      AI 老師講解
    </div>
    <button id="closeModalBtn" class="close-dialog-btn">&times;</button>
  </div>
  <div class="dialog-content" id="aiContent">思考中...</div>
</dialog>

<script>
/* ==================================================
   ★ 設定區：SHEET_ID 
   ================================================== */
const SHEET_ID = "16y8_QTo0QrQe5El9ylVvps94mhNi7zRuErIrxRkwoQc"; 

// 初始化 Iframe
const sheetFrame = document.getElementById("sheetFrame");
sheetFrame.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit?rm=minimal`;

/* ================= 變數宣告 ================= */
let pairs = [];        
let current = null;    
let mode = 0;          
let seqIndex = 0;      

// DOM 元素
const mainTextEl = document.getElementById("mainText");
const subTextEl = document.getElementById("subText");
const hintEl = document.getElementById("hint");
const speakBtn = document.getElementById("speakBtn");
const aiBtn = document.getElementById("aiBtn");
const showBtn = document.getElementById("showBtn");
const nextBtn = document.getElementById("nextBtn");
const textArea = document.getElementById("pairs");
const statusMsg = document.getElementById("statusMsg");
const toggleSheetBtn = document.getElementById("toggleSheetBtn");
const sheetContainer = document.getElementById("sheetContainer");
// Modal Elements
const aiModal = document.getElementById("aiModal");
const aiContent = document.getElementById("aiContent");
const closeModalBtn = document.getElementById("closeModalBtn");

/* ================= 核心邏輯 ================= */

function nextCard() {
  if (!pairs.length) {
    current = null;
    render();
    return;
  }
  if (mode === 3) {
    if (seqIndex >= pairs.length) seqIndex = 0; 
    const p = pairs[seqIndex];
    current = { p: p, d: 3 }; 
    seqIndex++; 
  } else {
    const p = pairs[Math.floor(Math.random() * pairs.length)];
    let d = 0;
    if (mode === 0) d = Math.random() < 0.5 ? 0 : 1;
    else if (mode === 1) d = 1; 
    else d = 0; 
    current = { p, d };
  }
  render();
}

function prevCard() {
  if (!pairs.length) return;
  if (mode === 3) {
    seqIndex -= 2;
    if (seqIndex < 0) seqIndex = pairs.length + seqIndex; 
    if (seqIndex < 0) seqIndex = 0;
    const p = pairs[seqIndex];
    current = { p: p, d: 3 };
    seqIndex++; 
    render();
  }
}

function render() {
  subTextEl.textContent = ""; 
  speakBtn.classList.add("hidden");
  aiBtn.classList.add("hidden"); 

  // 只要有題目，顯示發音和 AI 按鈕
  if (current) {
    speakBtn.classList.remove("hidden");
    speakBtn.onclick = (e) => {
        e.stopPropagation(); 
        speak(current.p.en); 
    };

    aiBtn.classList.remove("hidden");
    aiBtn.onclick = (e) => {
        e.stopPropagation();
        askGemini(current.p.en);
    };
  }

  if (mode === 3) {
      showBtn.textContent = "上一題";
      nextBtn.textContent = "下一題";
  } else {
      if (current && current.d === 0) showBtn.textContent = "顯示中文";
      else showBtn.textContent = "顯示英文";
      nextBtn.textContent = "下一題";
  }

  if (!current) {
    mainTextEl.textContent = pairs.length ? "請按下一題" : "題庫為空";
    hintEl.textContent = "";
    showBtn.textContent = "顯示翻譯";
    showBtn.disabled = true;
    return;
  }

  showBtn.disabled = false;

  if (mode === 3) {
    mainTextEl.textContent = current.p.zh;
    subTextEl.textContent = current.p.en;
    hintEl.textContent = `順序瀏覽: ${seqIndex} / ${pairs.length}`;
  } else if (current.d === 0) {
    mainTextEl.textContent = current.p.en;
    hintEl.textContent = "英文 → 中文";
    showBtn.textContent = "顯示中文";
  } else {
    mainTextEl.textContent = current.p.zh;
    hintEl.textContent = "中文 → 英文";
    showBtn.textContent = "顯示英文";
  }
}

function showAnswer() {
  if (!current) return;
  if (current.d === 0) subTextEl.textContent = current.p.zh;
  else subTextEl.textContent = current.p.en;
  showBtn.textContent = "隱藏翻譯";
}

function hideAnswer() {
  subTextEl.textContent = "";
  if (current.d === 0) showBtn.textContent = "顯示中文";
  else showBtn.textContent = "顯示英文";
}

/* ================= 發音功能 ================= */
function speak(text) {
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-US'; 
  utterance.rate = 0.9;     
  window.speechSynthesis.speak(utterance);
}

/* ================= AI Gemini 功能 ================= */
async function askGemini(word) {
    // 1. 介面顯示：開啟 Modal 並顯示載入中
    aiModal.showModal();
    aiContent.textContent = "AI 老師正在思考中...";
    
    // 2. 準備提示詞 (Prompt)
    const promptText = `請解釋英文單字 "${word}" 的中文意思，詞性，近似詞，返義詞，用法，並提供一個簡單的英文例句附帶中文翻譯。請用繁體中文回答。`;

    try {
        // ★ 3. 修改處：呼叫我們建立的 Vercel 後端，而非直接呼叫 Google
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                prompt: promptText // 將提示詞包裝在 prompt 欄位中傳給後端
            })
        });

        const data = await response.json();
        
        // 4. 錯誤處理
        if (!response.ok || data.error) {
             console.error("API Error:", data.error);
             // 讀取錯誤訊息，如果是物件就轉字串，否則直接顯示
             const errMsg = typeof data.error === 'object' ? JSON.stringify(data.error) : data.error;
             throw new Error(errMsg || "伺服器發生錯誤");
        }

        // 5. 解析資料 (因為後端是原樣轉傳 Google 的回應，所以這裡解析邏輯不用變)
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            throw new Error("AI 回傳內容為空");
        }

        let text = data.candidates[0].content.parts[0].text;
        
        // 6. 簡單的格式化 (轉 HTML)
        text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        aiContent.innerHTML = text;

    } catch (error) {
        console.error("Gemini Fetch Error:", error);
        aiContent.textContent = "發生錯誤：" + error.message;
    }
}

// 關閉 Modal
closeModalBtn.onclick = () => aiModal.close();
aiModal.addEventListener('click', (event) => {
    if (event.target === aiModal) aiModal.close();
});

/* ================= 工具函式 ================= */
function safeSplitLines(text) { return text.split(/\r?\n/).filter(x => x.trim()); }
function containsCJK(str) { return /[\u4E00-\u9FFF]/.test(str); }

function parsePairs(text) {
  const lines = safeSplitLines(text);
  const arr = [];
  for (const l of lines) {
    let sep = null;
    if (l.includes(" - ")) sep = " - ";
    else if (l.includes(",")) sep = ",";
    else if (l.includes("\t")) sep = "\t";
    if (!sep) continue;
    
    let p = l.split(sep).map(x => x.trim());
    if (p.length < 2) continue;
    
    let a = p[0], b = p[1];
    if (containsCJK(a)) arr.push({ zh: a, en: b });
    else if (containsCJK(b)) arr.push({ zh: b, en: a });
    else arr.push({ zh: a, en: b });
  }
  return arr;
}

/* ================= 匯入邏輯 ================= */
async function importSheet() {
  statusMsg.textContent = "載入中...";
  statusMsg.style.color = "var(--accent)";
  const sheetName = document.getElementById("sheetNameInput").value.trim();
  let url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
  if (sheetName) url += `&sheet=${encodeURIComponent(sheetName)}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("連線錯誤");
    let csv = await res.text();
    if (csv.trim().startsWith("<!doctype")) throw new Error("權限不足或工作表名稱錯誤");
    let lines = safeSplitLines(csv);
    let newLinesText = [];
    for (let L of lines) {
      let cleanL = L.replace(/""/g, '"');
      let parts = cleanL.split(",");
      if (parts.length < 2) continue;
      let c1 = parts[0].replace(/^"|"$/g, '').trim();
      let c2 = parts[1].replace(/^"|"$/g, '').trim();
      if (c1 && c2) newLinesText.push(`${c1} - ${c2}`);
    }
    if (!newLinesText.length) throw new Error("無資料");
    let newPairs = parsePairs(newLinesText.join("\n"));
    pairs = pairs.concat(newPairs); 
    textArea.value = pairs.map(p => `${p.zh} - ${p.en}`).join("\n");
    statusMsg.textContent = `成功加入 ${newPairs.length} 筆 (共 ${pairs.length} 筆)`;
    statusMsg.style.color = "green";
    if (!current) nextCard();
  } catch (e) {
    console.error(e);
    statusMsg.textContent = "失敗: " + e.message;
    statusMsg.style.color = "red";
    alert("匯入失敗，請檢查工作表名稱是否正確 (且權限為公開)。");
  }
}

/* ================= 事件綁定 ================= */
document.getElementById("importBtn").onclick = importSheet;
document.getElementById("clearBtn").onclick = () => {
  pairs = []; current = null; seqIndex = 0; textArea.value = ""; render(); statusMsg.textContent = "已清空";
};
nextBtn.onclick = nextCard;
showBtn.onclick = () => {
  if (mode === 3) { prevCard(); return; }
  if (subTextEl.textContent.trim() === "") showAnswer(); else hideAnswer();
};
toggleSheetBtn.onclick = () => {
  if (sheetContainer.style.display === 'block') {
    sheetContainer.style.display = 'none';
    toggleSheetBtn.textContent = '▼ 展開/隱藏 Google 試算表 (預覽與編輯)';
  } else {
    sheetContainer.style.display = 'block';
    toggleSheetBtn.textContent = '▲ 收起 Google 試算表';
  }
};
const modeBtns = ["m0", "m1", "m2", "m3"];
modeBtns.forEach((id, index) => {
  document.getElementById(id).onclick = () => {
    mode = index;
    if (mode === 3) seqIndex = 0;
    modeBtns.forEach((x, j) => document.getElementById(x).classList.toggle("active", j === index));
    nextCard();
  };
});
textArea.addEventListener('input', () => {
  const text = textArea.value; pairs = parsePairs(text); statusMsg.textContent = `手動更新: ${pairs.length} 筆`;
});
</script>
</body>
</html>

